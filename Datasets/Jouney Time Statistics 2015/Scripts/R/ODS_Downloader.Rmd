---
title: "ODS Downloader"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Intro

Short Rmd to take care of downloading and converting the travel time datasets from gov.uk. These are all in ODS format. (Open Document Format for spreadsheets <https://en.wikipedia.org/wiki/OpenDocument>) 


Define a dataframe of the names and locations of the travel time datasets on gov.uk:
```{r}
# "Journey times to key services by local authority (JTS04)"
# "https://www.gov.uk/government/statistical-data-sets/journey-times-to-key-services-by-local-authority-jts04"

Code <- c(
"jts0104",
"jts0401",
"jts0402",
"jts0403",
"jts0404",
"jts0405",
"jts0406",
"jts0407",
"jts0408",
"jts0409")

Description <- c(
"Average minimum travel time to reach the nearest key services by mode of travel, local authority: England",
"Travel time, destination and origin indicators for Employment centers by mode of travel and local authority, England",
"Travel time, destination and origin indicators for Primary schools by mode of travel and local authority, England",
"Travel time, destination and origin indicators for Secondary schools by mode of travel and local authority, England",
"Travel time, destination and origin indicators for Further education by mode of travel and local authority, England",
"Travel time, destination and origin indicators for GPs by mode of travel and local authority, England",
"Travel time, destination and origin indicators for Hospitals by mode of travel and local authority, England",
"Travel time, destination and origin indicators for Food stores by mode of travel and local authority, England",
"Travel time, destination and origin indicators for Town centres by mode of travel and local authority, England",
"Travel time, destination and origin indicators to Pharmacy by cycle and car, local authority, England")

url <- c(
"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/627322/jts0104.ods",
"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/640763/jts0401.ods",
"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/627353/jts0402.ods",
"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/627354/jts0403.ods",
"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/627355/jts0404.ods",
"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/627356/jts0405.ods",
"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/627347/jts0406.ods",
"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/627349/jts0407.ods",
"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/627350/jts0408.ods",
"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/659933/jts0409.ods")

size <- c(
"36.4KB",
"664KB",
"214KB",
"259KB",
"267KB",
"236KB",
"288KB",
"235KB",
"279KB",
"99.8KB")

# Row number of the headers in the metadata and data tabs
DataHeaders <- c(8,7,7,7,7,7,7,7,7,7)
MetaHeaders <- c(NA,11,11,11,11,11,11,11,11,25)

datasets <- data.frame(Code, Description, url, size, DataHeaders, MetaHeaders)
rm(Code, Description, url, size, DataHeaders, MetaHeaders)
```


# Download ODS files from links in datasets data frame. (Note mode=wb to correctly download binary files.)
```{r}


srcdat="../../Source Data/"

for(i in 1:length(datasets$Code)){
  
  download.file(as.character(datasets$url[i]), paste0(srcdat,datasets$Code[i],".ods"), mode="wb")
}

```


Read these ODS files into R as data frames.
```{r}
library(readODS)

#Initialise list of travel time data
ttd=list()

for(i in 1:length(datasets$Code)){
  
  #Read 2015 tab of ODS file to a data frame, starting at the row defined by DataHeaders
   df <- read_ods( path = paste0(srcdat,datasets$Code[i],".ods"), 
                  sheet = "2015", 
                  col_names = TRUE,
                  skip = datasets$DataHeaders[i]-1)
   
   print(i)
   # Removes rows where the second column is empty and stuffs data frame into named list (Named using code)
   ttd[[as.character(datasets$Code[i])]] <- subset(df, !is.na(df[,2]))
                        
}

# Tidy up temporary data frame and iterator
rm(df, i)
```

Read the metadata in the same way - provides the codelist
```{r}
library(readODS)

ttd_meta=list()

for(i in 1:length(datasets$Code)){
  
  if(!is.na(datasets$MetaHeaders[i])){ #Skip for files where there is no metadata sheet (as defined in MetaHeaders)
    
    print(paste0(srcdat,datasets$Code[i],".ods"))
  #Read 2015 tab of ODS file to a data frame, starting at the row defined by DataHeaders
   df <- read_ods( path = paste0(srcdat,datasets$Code[i],".ods"), 
                  sheet = "LA_Metadata", 
                  col_names = TRUE,
                  skip = datasets$MetaHeaders[i]-1)
   
   print(i)
   # Removes rows where the second column is empty and stuffs data frame into named list (Named using code)
   ttd_meta[[as.character(datasets$Code[i])]] <- subset(df, !is.na(df[,2]))
  }                   
}

# Tidy up temporary data frame and iterator
rm(df, i)
```