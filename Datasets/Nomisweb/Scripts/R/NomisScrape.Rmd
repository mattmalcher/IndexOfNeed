---
title: "NomisScrape"
author: "Matthew Malcher"
date: "29/11/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Prerequisites.
This file requires that `SDMX Access.Rmd` be run first to define all the functions and load all the relevant libraries for accessing data via the Nomis API.

# Get JSA Data
## Find JSA variables

Get a table of the nomis variables which are in the JSA category.

```{r}
jsaDatasets <- get_datasets_by_contenttype('jsa')

jsaDatasets$id
jsaDatasets$Description.en

get_datasets_by_contenttype('jsa')
```

Looking at `jsaDatasets$Name.en` we can pick a few of these which we think are relevant or interesting:

* NM_1_1 - Jobseeker's Allowance with rates and proportions
* NM_7_1 - claimant count - occupation, age and duration
* NM_10_1 - Jobseeker's Allowance flows

We now want to check that these are available for our desired output type - Local Authority Areas

```{r}
OAs_NM_1_1 <- available_OAs(ap,qformat,'NM_1_1','2092957697') %>% filter(id =='2092957697TYPE464')
OAs_NM_7_1 <- available_OAs(ap,qformat,'NM_7_1','2092957697') %>% filter(id =='2092957697TYPE464')
OAs_NM_10_1 <- available_OAs(ap,qformat,'NM_10_1','2092957697') %>% filter(id =='2092957697TYPE464')

OAs_NM_1_1
OAs_NM_7_1
OAs_NM_10_1
```

We can see that all three variables are available at local authority level. Good!

Now we can get the list of output areas available for each dataset.
```{r}
OAlist_NM_1_1 <- list_OAs(ap,qformat,'NM_1_1','2092957697','TYPE464')
OAlist_NM_7_1 <- list_OAs(ap,qformat,'NM_7_1','2092957697','TYPE464')
OAlist_NM_10_1 <- list_OAs(ap,qformat,'NM_10_1','2092957697','TYPE464')
```

We can check that the output areas are identical for the three datasets, and then remove the duplicate variables.
```{r}
identical(OAlist_NM_1_1,OAlist_NM_7_1)
identical(OAlist_NM_1_1,OAlist_NM_10_1)
OAlist <-OAlist_NM_1_1
rm(OAlist_NM_1_1,OAlist_NM_7_1,OAlist_NM_10_1)
```

Next we can check which measures we want for each dataset.
```{r}

get_measures(ap,qformat,'NM_1_1','2092957697','TYPE464')
get_measures(ap,qformat,'NM_7_1','2092957697','TYPE464')
get_measures(ap,qformat,'NM_10_1','2092957697','TYPE464')

```
```{r}
get_items(ap,'NM_1_1',qformat)
get_items(ap,'NM_7_1',qformat)
get_items(ap,'NM_10_1',qformat)
```
Get NM_1_1 Data
```{r}

data_NM_1_1 <- get_data('NM_1_1',
                        '2092957697TYPE464',       # Local Authority Areas
                        3,                         # Genders: Total for both Genders
                        '1',                       # Item: Total Claimints
                        '20100,20201,20202,20203', # Measures: claimants, workforce, active, residence
                        dformat,                   # sdmx data format
                        1)                         # Latest Time
```

Get NM_7_1 Data
```{r}

data_NM_7_1 <- get_data('NM_7_1',
                        '2092957697TYPE464',       # Local Authority Areas
                        3,                         # Genders: Total for both Genders
                        '1',                     # Item: Sought & Usual Occupation
                        '20100',                   # Measures: value only
                        dformat,                   # sdmx data format
                        1)                         # Latest Time
```

Get NM_10_1 Data
```{r}
data_NM_10_1 <- get_data('NM_10_1',
                        '2092957697TYPE464',       # Local Authority Areas
                        3,                         # Genders: Total for both Genders
                        '1',                       # Item: Total Claimints
                        '20100',                   # Measures: value only
                        dformat,                   # sdmx data format
                        1)                         # Latest Time
```

We notice that we get 1624 rows for NM_1_1, 112 for 

